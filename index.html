<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JSFiddle wdn6vasc</title>

  <style>
    body,
    html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000;
    }

    canvas {
        width: 100vw;
        height: 100vh;
    }

    dialog {
        width: 100%;
        text-align: center;
        max-width: 20em;
        color: white;
        background-color: #000;
        border: none;
        position: relative;
        transform: translate(-50%, -50%);
    }

    #progress-container {
        position: absolute;
        top: 50%;
        left: 50%;
    }

    progress {
        width: 100%;
        height: 1em;
        border: none;
        background-color: #fff;
        color: #eee;
    }

    progress::-webkit-progress-bar {
        background-color: #333;
    }

    progress::-webkit-progress-value {
        background-color: #eee;
    }

    progress::-moz-progress-bar {
        background-color: #eee;
    }

    #ar-button {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 10; /* Ensure it's above the canvas */
    }
  </style>


</head>
<body>
  <!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="style.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>gsplat.js - Viewer Demo</title>
    </head>

    <body>
        <div id="progress-container">
            <dialog open id="progress-dialog">
                <p>
                    <label for="progress-indicator">Loading scene...</label>
                </p>
                <progress max="100" id="progress-indicator"></progress>
            </dialog>
        </div>
        <button id="ar-button">Enter AR</button>
        <canvas id="canvas"></canvas>
    </body>
</html>


  <script type="module">
    import * as SPLAT from "https://cdn.jsdelivr.net/npm/gsplat@latest";

    const canvas = document.getElementById("canvas");
    const progressDialog = document.getElementById("progress-dialog");
    const progressIndicator = document.getElementById("progress-indicator");
    const arButton = document.getElementById("ar-button");

    const renderer = new SPLAT.WebGLRenderer(canvas);
    const scene = new SPLAT.Scene();
    const camera = new SPLAT.Camera();
    const controls = new SPLAT.OrbitControls(camera, canvas);
    let xrSession = null;
    let xrReferenceSpace = null;
    let gl = null;

    async function main() {
        const url = "https://huggingface.co/cakewalk/splat-data/resolve/main/nike.splat";

        await SPLAT.Loader.LoadAsync(url, scene, (progress) => progressIndicator.value = progress * 100);
        progressDialog.close();

        const handleResize = () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            if (xrSession) {  //If there is a session, we should adjust to the session's viewport
                gl.bindFramebuffer(gl.FRAMEBUFFER, xrSession.renderState.baseLayer.framebuffer);
                const viewport = xrSession.renderState.baseLayer.getViewport(xrSession.renderState.views[0]);
              renderer.setSize(viewport.width, viewport.height, false);
            }
        };

        const frame = (time, xrFrame) => {
          if(xrFrame) {
              xrSession.requestAnimationFrame(frame);
              const pose = xrFrame.getViewerPose(xrReferenceSpace);
              if(pose) {
                const view = pose.views[0];
                const viewport = xrSession.renderState.baseLayer.getViewport(view);
                renderer.setSize(viewport.width, viewport.height, false);
                gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
                camera.updateFromXR(view.transform.inverse.matrix, view.projectionMatrix);
                renderer.render(scene, camera);
              }

          } else {
            controls.update();
            renderer.render(scene, camera);
            requestAnimationFrame(frame);
          }
        };

        handleResize();
        window.addEventListener("resize", handleResize);

        requestAnimationFrame(frame);

        setupAR();
    }

    async function setupAR() {
        if ("xr" in navigator) {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                if (supported) {
                    arButton.disabled = false;
                } else {
                    arButton.textContent = "AR not supported";
                    arButton.disabled = true;
                }
            });

            arButton.addEventListener("click", toggleAR);
        } else {
            arButton.textContent = "WebXR not found";
            arButton.disabled = true;
        }
    }

    async function toggleAR() {
        if (!xrSession) {
             navigator.xr.requestSession('immersive-ar', {
                 requiredFeatures: ['local', 'hit-test'], // Request hit-testing
             }).then(async (session) => {
              xrSession = session;
              arButton.textContent = "Exit AR";

              gl = renderer.getContext();
              await gl.makeXRCompatible();
              session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

               // Set up the hit-test source
              session.requestReferenceSpace('viewer').then((refSpace) => {
                session.requestHitTestSource({ space: refSpace }).then((hitTestSource) => {
                  // Store a reference to the hit test source, we'll use this later!
                    renderer.xrHitTestSource = hitTestSource; //Very important for later.
                });
              });

              session.requestReferenceSpace('local').then((refSpace) => {
                  xrReferenceSpace = refSpace;
                  xrSession.requestAnimationFrame(frame);
              });

                session.addEventListener("end", () => {
                    xrSession = null;
                    xrReferenceSpace = null;
                    arButton.textContent = "Enter AR";
                    gl = null;
                     renderer.xrHitTestSource = null; //Clean the hit test.
                    // Restore the canvas size.
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    requestAnimationFrame(frame); //Back to the non-AR rendering loop.
                });

            });

        } else {
            xrSession.end();
        }
    }
    
    //Helper function to update camera from the XR data
    SPLAT.Camera.prototype.updateFromXR = function (viewMat, projMat) {
      this.viewMatrix.elements = viewMat;
      this.projectionMatrix.elements = projMat;

      this.position.setFromMatrixPosition(this.viewMatrix);
      this.rotation.setFromRotationMatrix(this.viewMatrix);

      this.updateMatrixWorld(true);
      this.updateProjectionMatrix(); // Important to update the derived matrices
    };


    main();
  </script>
</body>
</html>