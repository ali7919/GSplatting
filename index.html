<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Gaussian Splat AR Viewer</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #000;
    }
    canvas {
      width: 100vw;
      height: 100vh;
    }
    #arButton {
      position: absolute;
      top: 1em;
      left: 1em;
      z-index: 10;
      background: #fff;
      border: none;
      padding: 0.5em 1em;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="arButton" hidden>Enter AR</button>
  <canvas id="canvas"></canvas>

  <script type="module">
    import * as SPLAT from "https://cdn.jsdelivr.net/npm/gsplat@latest";

    const canvas = document.getElementById("canvas");
    const arButton = document.getElementById("arButton");
    const renderer = new SPLAT.WebGLRenderer(canvas);
    const scene = new SPLAT.Scene();
    const camera = new SPLAT.Camera();
    const controls = new SPLAT.OrbitControls(camera, canvas);

    let xrSession = null;
    let xrRefSpace = null;

    async function initScene() {
      const url = "https://huggingface.co/cakewalk/splat-data/resolve/main/nike.splat";
      await SPLAT.Loader.LoadAsync(url, scene);
      controls.update();
      renderer.setSize(window.innerWidth, window.innerHeight);
      animate();
    }

    function animate() {
      if (!xrSession) {
        controls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }
    }

    // Check if AR is supported
    if (navigator.xr) {
      navigator.xr.isSessionSupported("immersive-ar").then((supported) => {
        if (supported) {
          arButton.hidden = false;
          arButton.addEventListener("click", onRequestARSession);
        }
      });
    }

    async function onRequestARSession() {
      try {
        xrSession = await navigator.xr.requestSession("immersive-ar", {
          requiredFeatures: ["hit-test", "local-floor"]
        });
        xrSession.addEventListener("end", onSessionEnded);

        const gl = renderer.getContext();
        await gl.makeXRCompatible();
        xrSession.updateRenderState({ baseLayer: new XRWebGLLayer(xrSession, gl) });
        xrRefSpace = await xrSession.requestReferenceSpace("local-floor");

        xrSession.requestAnimationFrame(onXRAnimationFrame);
      } catch (e) {
        console.error("Failed to start AR session:", e);
      }
    }

    function onSessionEnded() {
      xrSession = null;
      xrRefSpace = null;
      requestAnimationFrame(animate);
    }

    function onXRAnimationFrame(t, frame) {
      const session = frame.session;
      session.requestAnimationFrame(onXRAnimationFrame);
      const pose = frame.getViewerPose(xrRefSpace);
      const gl = renderer.getContext();

      gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);

      if (pose) {
        // Update camera projection & view from XR pose
        const view = pose.views[0];
        const vp = view.viewport;
        gl.viewport(vp.x, vp.y, vp.width, vp.height);

        camera.setFromProjectionMatrix(view.projectionMatrix);    
        renderer.render(scene, camera, { transform: view.transform.matrix });
      }
    }

    window.addEventListener("resize", () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    initScene();
  </script>
</body>
</html>