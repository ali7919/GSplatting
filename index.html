<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>GSplat AR</title>

  <style>
    body,
    html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000;
        height: 100%; /* Important for WebXR to work correctly */
        width: 100%;
    }

    canvas {
        width: 100vw;
        height: 100vh;
        /*  display: block;  /* Important: prevents scrollbars */
    }

    dialog {
        width: 100%;
        text-align: center;
        max-width: 20em;
        color: white;
        background-color: #000;
        border: none;
        position: relative;
        transform: translate(-50%, -50%);
    }

    #progress-container {
        position: absolute;
        top: 50%;
        left: 50%;
    }

    progress {
        width: 100%;
        height: 1em;
        border: none;
        background-color: #fff;
        color: #eee;
    }

    progress::-webkit-progress-bar {
        background-color: #333;
    }

    progress::-webkit-progress-value {
        background-color: #eee;
    }

    progress::-moz-progress-bar {
        background-color: #eee;
    }

      #ar-button {
          position: absolute;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          padding: 10px 20px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          display: none; /* Initially hidden */
          z-index: 10;  /* Ensure button is above canvas */
      }

  </style>


</head>
<body>

    <div id="progress-container">
        <dialog open id="progress-dialog">
            <p>
                <label for="progress-indicator">Loading scene...</label>
            </p>
            <progress max="100" id="progress-indicator"></progress>
        </dialog>
    </div>
    <button id="ar-button">Enter AR</button>
    <canvas id="canvas"></canvas>


  <script type="module">
    import * as SPLAT from "https://cdn.jsdelivr.net/npm/gsplat@latest";
    import * as THREE from 'three';  // Import Three.js

    const canvas = document.getElementById("canvas");
    const progressDialog = document.getElementById("progress-dialog");
    const progressIndicator = document.getElementById("progress-indicator");
    const arButton = document.getElementById("ar-button");

    const renderer = new SPLAT.WebGLRenderer(canvas);
    const scene = new SPLAT.Scene();
    const camera = new SPLAT.Camera();
   // const controls = new SPLAT.OrbitControls(camera, canvas); // Remove OrbitControls for AR

    // WebXR Setup
    let xrSession = null;
    let gl = null;
      let xrRefSpace = null;

    async function initXR() {
        if (!navigator.xr) {
            alert("WebXR not supported in this browser.");
            return;
        }

        try {
                const sessionInit = {
                    requiredFeatures: ['local'], // Use 'local' for basic AR
                   optionalFeatures: [ 'dom-overlay', 'hit-test' ],
                   domOverlay: { root: document.body }

                };

            xrSession = await navigator.xr.requestSession("immersive-ar", sessionInit);
            gl = renderer.getInternalThreeContext(); // Get Three.js context from gsplat renderer
             gl.makeXRCompatible();  // Important!
            xrSession.updateRenderState({ baseLayer: new XRWebGLLayer(xrSession, gl) });

              xrRefSpace = await xrSession.requestReferenceSpace('local');

            xrSession.addEventListener("end", onXRSessionEnded);

              xrSession.requestAnimationFrame(onXRFrame);


        } catch (error) {
            console.error("Error initializing XR session:", error);
            alert("Failed to initialize AR session: " + error.message);
        }
    }
      function onXRSessionEnded() {
        xrSession = null;

         location.reload();
      }

      function onXRFrame(time, frame) {

            if (!xrSession) return;
          xrSession.requestAnimationFrame(onXRFrame);

          const pose = frame.getViewerPose(xrRefSpace);

          if (pose) {
            const layer = xrSession.renderState.baseLayer;
             gl.bindFramebuffer(gl.FRAMEBUFFER, layer.framebuffer);

            for (const view of pose.views) {
                const viewport = layer.getViewport(view);
                renderer.setSize(viewport.width, viewport.height);  // Use XR viewport size
                const p = view.projectionMatrix;
                const t = view.transform;

                // Update camera matrix *directly* from the WebXR pose:
                camera.projectionMatrix.copy([
                  p[0], p[1], p[2], p[3],
                  p[4], p[5], p[6], p[7],
                  p[8], p[9], p[10], p[11],
                  p[12], p[13], p[14], p[15]
                ]);

                camera.viewMatrix.copy([
                    t.matrix[0], t.matrix[1], t.matrix[2], t.matrix[3],
                    t.matrix[4], t.matrix[5], t.matrix[6], t.matrix[7],
                    t.matrix[8], t.matrix[9], t.matrix[10], t.matrix[11],
                    t.matrix[12], t.matrix[13], t.matrix[14], t.matrix[15]
                ]);
                camera.position.copy([t.position.x, t.position.y, t.position.z]);
                camera.quaternion.copy([t.orientation.x, t.orientation.y, t.orientation.z, t.orientation.w]);

              renderer.render(scene, camera);
            }
          }

      }


    async function main() {
        const url = "https://huggingface.co/cakewalk/splat-data/resolve/main/nike.splat";

        await SPLAT.Loader.LoadAsync(url, scene, (progress) => progressIndicator.value = progress * 100);
        progressDialog.close();

          arButton.style.display = "block";  // Show the AR button after loading
          arButton.addEventListener("click", initXR);

        // No need for resize handler or requestAnimationFrame here; XR handles it.
    }

    main();

  </script>
</body>
</html>