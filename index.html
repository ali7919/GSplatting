<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>gsplat.js - AR Viewer</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
        }

        canvas {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        dialog {
            width: 100%;
            text-align: center;
            max-width: 20em;
            color: white;
            background-color: #000;
            border: none;
            position: relative;
            transform: translate(-50%, -50%);
        }

        #progress-container {
            position: absolute;
            top: 50%;
            left: 50%;
            z-index: 100;
        }

        progress {
            width: 100%;
            height: 1em;
            border: none;
            background-color: #fff;
            color: #eee;
        }

        progress::-webkit-progress-bar {
            background-color: #333;
        }

        progress::-webkit-progress-value {
            background-color: #eee;
        }

        progress::-moz-progress-bar {
            background-color: #eee;
        }

        #ar-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid white;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }

        #ar-not-supported {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="progress-container">
        <dialog open id="progress-dialog">
            <p>
                <label for="progress-indicator">Loading scene...</label>
            </p>
            <progress max="100" id="progress-indicator"></progress>
        </dialog>
    </div>
    
    <canvas id="canvas"></canvas>
    <button id="ar-button">Enter AR</button>
    <div id="ar-not-supported">
        <p>AR is not supported on your device or browser.</p>
    </div>

    <script type="module">
        import * as SPLAT from "https://cdn.jsdelivr.net/npm/gsplat@latest";

        const canvas = document.getElementById("canvas");
        const progressDialog = document.getElementById("progress-dialog");
        const progressIndicator = document.getElementById("progress-indicator");
        const arButton = document.getElementById("ar-button");
        const arNotSupported = document.getElementById("ar-not-supported");

        const renderer = new SPLAT.WebGLRenderer(canvas);
        const scene = new SPLAT.Scene();
        const camera = new SPLAT.Camera();
        const controls = new SPLAT.OrbitControls(camera, canvas);

        let xrSession = null;
        let xrRefSpace = null;
        let xrHitTestSource = null;
        let modelPlaced = false;
        
        // Check if AR is supported
        function checkARSupport() {
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-ar')
                    .then((supported) => {
                        if (supported) {
                            arButton.style.display = 'block';
                            
                            // Auto-start AR if possible
                            startARSession();
                        } else {
                            arNotSupported.style.display = 'block';
                        }
                    });
            } else {
                arNotSupported.style.display = 'block';
            }
        }

        // Start AR session
        function startARSession() {
            if (navigator.xr) {
                navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test', 'dom-overlay'],
                    domOverlay: { root: document.body }
                }).then(onARSessionStarted, () => {
                    arNotSupported.style.display = 'block';
                });
            }
        }

        // Handle AR session start
        function onARSessionStarted(session) {
            xrSession = session;
            xrSession.addEventListener('end', onARSessionEnded);
            
            // Set up WebXR rendering
            renderer.xr.enabled = true;
            renderer.xr.setReferenceSpaceType('local');
            renderer.xr.setSession(xrSession);
            
            xrSession.requestReferenceSpace('local').then((refSpace) => {
                xrRefSpace = refSpace;
                
                xrSession.requestHitTestSource({ space: refSpace })
                    .then((hitTestSource) => {
                        xrHitTestSource = hitTestSource;
                    });
                
                xrSession.updateRenderState({
                    baseLayer: new XRWebGLLayer(xrSession, renderer.gl)
                });
                
                // Start AR rendering loop
                xrSession.requestAnimationFrame(onXRFrame);
            });
        }

        // Handle AR session end
        function onARSessionEnded() {
            xrSession = null;
            renderer.xr.enabled = false;
            renderer.xr.setSession(null);
            modelPlaced = false;
            
            // Restart normal rendering
            requestAnimationFrame(frame);
        }

        // XR Frame update
        function onXRFrame(time, frame) {
            if (!xrSession) return;
            
            const session = frame.session;
            session.requestAnimationFrame(onXRFrame);
            
            const pose = frame.getViewerPose(xrRefSpace);
            if (pose) {
                // Get the pose and view matrices for AR
                const view = pose.views[0];
                const viewport = session.renderState.baseLayer.getViewport(view);
                renderer.gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
                
                // Update camera from AR view
                camera.matrix.fromArray(view.transform.matrix);
                camera.matrix.invert();
                camera.projectionMatrix.fromArray(view.projectionMatrix);
                
                // Try to place the model if not already placed
                if (!modelPlaced && xrHitTestSource) {
                    const hitTestResults = frame.getHitTestResults(xrHitTestSource);
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        const hitPose = hit.getPose(xrRefSpace);
                        
                        // Place the scene at the hit test position
                        scene.position.set(
                            hitPose.transform.position.x,
                            hitPose.transform.position.y,
                            hitPose.transform.position.z
                        );
                        
                        // Scale the model appropriately for AR
                        scene.scale.set(0.5, 0.5, 0.5);
                        
                        modelPlaced = true;
                    }
                }
                
                // Render the scene for AR
                renderer.render(scene, camera);
            }
        }

        // Regular frame update (non-AR)
        function frame() {
            if (xrSession) return;
            
            controls.update();
            renderer.render(scene, camera);
            requestAnimationFrame(frame);
        }

        async function main() {
            const url = "https://huggingface.co/cakewalk/splat-data/resolve/main/nike.splat";

            await SPLAT.Loader.LoadAsync(url, scene, (progress) => progressIndicator.value = progress * 100);
            progressDialog.close();

            const handleResize = () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
            };

            handleResize();
            window.addEventListener("resize", handleResize);
            
            // Setup AR button
            arButton.addEventListener('click', startARSession);
            
            // Check AR support and try to start AR automatically
            checkARSupport();
            
            // Start normal rendering as fallback
            requestAnimationFrame(frame);
        }

        main();
    </script>
</body>
</html>