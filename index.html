<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GSplat AR Demo</title>
  <style>
    /* Add button styling */
    #enter-ar {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px 20px;
      background: white;
      color: black;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Existing styles remain unchanged */
    body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
    canvas { width: 100vw; height: 100vh; }
    dialog { /* ... */ }
    #progress-container { /* ... */ }
    progress { /* ... */ }
  </style>
</head>
<body>
  <button id="enter-ar">Enter AR</button>
  <!-- Existing HTML structure remains -->
  <div id="progress-container">
    <dialog open id="progress-dialog">
      <p><label for="progress-indicator">Loading scene...</label></p>
      <progress max="100" id="progress-indicator"></progress>
    </dialog>
  </div>
  <canvas id="canvas"></canvas>

  <script type="module">
    import * as SPLAT from "https://cdn.jsdelivr.net/npm/gsplat@latest";

    const canvas = document.getElementById("canvas");
    const progressDialog = document.getElementById("progress-dialog");
    const progressIndicator = document.getElementById("progress-indicator");
    const enterARButton = document.getElementById("enter-ar");

    const renderer = new SPLAT.WebGLRenderer(canvas);
    const scene = new SPLAT.Scene();
    const camera = new SPLAT.Camera();
    const controls = new SPLAT.OrbitControls(camera, canvas);

    async function main() {
      const url = "https://huggingface.co/cakewalk/splat-data/resolve/main/nike.splat";
      await SPLAT.Loader.LoadAsync(url, scene, (progress) => progressIndicator.value = progress * 100);
      progressDialog.close();

      // Handle window resize
      const handleResize = () => renderer.setSize(window.innerWidth, window.innerHeight);
      handleResize();
      window.addEventListener("resize", handleResize);

      // Regular render loop
      function frame() {
        controls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    // AR functionality
    enterARButton.addEventListener("click", async () => {
      if (!navigator.xr) {
        alert("WebXR not supported");
        return;
      }

      try {
        const supported = await navigator.xr.isSessionSupported("immersive-ar");
        if (!supported) {
          alert("AR not supported");
          return;
        }

        const session = await navigator.xr.requestSession("immersive-ar");
        const gl = renderer.context;
        
        // Set up XR layer
        const xrLayer = new XRWebGLLayer(session, gl);
        await session.updateRenderState({ baseLayer: xrLayer });
        
        const refSpace = await session.requestReferenceSpace("local");

        // AR render loop
        const onXRFrame = (time, frame) => {
          const pose = frame.getViewerPose(refSpace);
          if (!pose) return;

          gl.bindFramebuffer(gl.FRAMEBUFFER, xrLayer.framebuffer);

          // Render each view
          pose.views.forEach((view) => {
            const viewport = xrLayer.getViewport(view);
            gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);

            // Update camera matrices for XR view
            camera.projectionMatrix.elements = view.projectionMatrix;
            const viewMatrix = new SPLAT.Matrix4().fromArray(view.transform.inverse.matrix);
            camera.matrixWorld.getInverse(viewMatrix);
            camera.matrixWorld.decompose(camera.position, camera.quaternion, camera.scale);
            camera.updateMatrixWorld(true);

            renderer.render(scene, camera);
          });

          session.requestAnimationFrame(onXRFrame);
        };

        session.requestAnimationFrame(onXRFrame);
      } catch (error) {
        console.error("AR session failed:", error);
      }
    });

    main();
  </script>
</body>
</html>